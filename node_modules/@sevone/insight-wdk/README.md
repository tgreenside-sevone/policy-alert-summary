# Data Insight Widget Developer Kit

A library of helpful tools to use while developing a widget.

## Quick Overview

### What's included?

* [API Client](#api-client)
* [Asset Manager](#asset-manager)
* [Messages](#messages)

### Installation

Using `npm`:

```sh
npm install @sevone/insight-wdk
```

Using `yarn`:

```sh
yarn add @sevone/insight-wdk
```

## API Client

A library for quickly and easily accessing data from our
[GraphQL](http://graphql.org/) api.

### How to use

The api library is exported as `apiClient` and requires you configure it with
relevant credentials and host information:

```js
import { apiClient } from 'insight-wdk';

const instance = apiClient.sevone({
  authToken: 'foobar',
  serverHost: 'https://example.com'
});

const data = await instance.request('gql query', {/* gql variables */});
```

### API

#### Creating an instance

You can create a new instance of the SevOne api client with a custom config.

##### `sevone(config)`

```js
const instance = apiClient.sevone({
  authToken: 'foobar',
  serverHost: 'https://example.com'
});
```

#### Instance methods

##### `setAuthToken(token)`

Updates the authentication token used when making requests.

##### `setServer(url)`

Updates the url requests are made to.

##### `request(gqlQuery, variables)`

Makes a request using the GraphQL query and variables.

##### `subscribe(gqlQuery, variables, onDataReceived)`

Initializes a gql subscription using web sockets. Every time data is received
from the server over the socket connection, the `onDataReceived` is triggered
with a single `data` argument.

#### Instance config

These are the available configuration options for making requests. Only the
`serverHost` is required.

```js
{
  // 'serverHost' is the server URL that will be used for the request
  serverHost: 'https://example.com/gql',

  // 'authToken' is the authentication token that will be used with the request
  authToken: '',
}
```

## Asset Manager

If your widget includes static assets, use the asset manager to access them.

### How to use

The api library is exported as `assetManager` and requires you configure it
with a base path to a wdk server:

```js
import { assetManager } from 'insight-wdk';

assetManager.setBasePath('http://my-data-insight.com/wdkserver');

// my-widget.js
assetManager.registerAsset({
  name: 'background',
  widgetId: 'my-widget'
  data: assetManager.getPath('my-widget', '/assets/background.png')
});
```

### API

#### `setBasePath(path: string) => void`

Configurate the asset manager to point at the wdk server hosting the static
assets.

#### `getPath(widgetId: string, additionalPath: string) => string`

Get the full path to `additionalPath` for your supplied widget.

#### `registerAsset({ name: string, widgetId: string, data: string }) => void`

Register your asset by name to your widget so you can access it by name later.
The data can be any arbitrary string, so that includes a url, data blob, etc.

#### `fetchAsset({ name: string, widgetId: string }) => string | null`

If you have registered an asset as `name` for your widget, this will return its
`data` field.

## Messages

Widgets are allowed to communicate with their host application through a list
of pre-defined messages.

This is intended to be done through a widget's `onMessage` prop:

```js
import { messages } from '@sevone/insight-wdk';

// ...

this.props.onMessage(messages.updateConfiguration, nextConfig);
```

A message always takes a message parameter, and then an optional `payload`
depending on the message being sent.

### Types

#### `onMessage(updateConfiguration, nextConfig: Object)`

This will likely be the most common message sent. When a widget wishes to
update its configuration, send the `updateConfiguration` along with the part
of the configuration that should be changed. This performs a shallow merge
on top of the previous configuration object.

#### `onMessage(setData, nextData: (prevData) => Object | Object)`

While it is recommended that a widget uses the `fetchData` interface to fetch
data, advanced use cases can break out of this system and manage data on its
own. In this case when the widget fetches new data and wishes to notify the wdk
of a change, send the `setData` message along with the new data payload.

**This will completely overwrite the previously stored data.**

If you need to retain some of that previous data, pass a function as the payload and it'll be called with the previous data as its argument.

#### `onMessage(dataInteraction, payload: Object)`

**Note:** This is largely a work in progress.

If a user can interact with your data, such as clicking a slice in a pie chart,
you may find it useful to notify the host application of this interaction.
As there is no defined behavior by the host application for this message, use
this sparingly.